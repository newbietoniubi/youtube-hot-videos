<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>YouTube Shorts åˆ†æä»ªè¡¨æ¿</title>
  <style>
    :root {
      --bg: #F9F9F7;
      --panel: #FFFFFF;
      --muted: #666666;
      --text: #1A1A1A;
      --primary: #437946;
      --border: #E5E7EB;
      --font-serif: "Georgia", "Times New Roman", serif;
      --font-sans: "Inter", "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-family: var(--font-serif);
      font-weight: normal;
      color: #111;
    }

    header {
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button.secondary,
    a.secondary {
      background: #EBEBE8;
      color: var(--text);
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 500;
      font-size: 14px;
    }

    button.secondary:hover,
    a.secondary:hover {
      background: #dededb;
    }

    main {
      padding: 16px 20px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--muted);
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #F2F2F0;
      color: var(--text);
      outline: none;
      transition: border-color .2s;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      background: #fff;
    }

    .row {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #1e1e1e;
      color: #fff;
      padding: 16px;
      border-radius: 12px;
      border: none;
      max-height: 220px;
      overflow: auto;
      font-family: monospace;
      font-size: 13px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .stat {
      padding: 16px;
      border-radius: 16px;
      background: #F4F4F2;
      border: none;
    }

    .stat .label {
      color: var(--muted);
      font-size: 13px;
    }

    .stat .value {
      font-size: 22px;
      font-weight: 700;
      margin-top: 4px;
    }

    .quick-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .pill {
      padding: 6px 14px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      transition: all .2s;
    }

    .pill:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #f0fdf4;
    }

    .gear-spin {
      display: inline-block;
      animation: gearSpin 1s linear infinite;
      transform-origin: 50% 50%;
    }

    @keyframes gearSpin {
      to {
        transform: rotate(360deg);
      }
    }

    .charts {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .chart {
      height: 320px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text);
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      color: var(--muted);
      font-weight: 600;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    a.link {
      color: #38bdf8;
      text-decoration: none;
    }

    a.link:hover {
      text-decoration: underline;
    }

    .log-header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .chevron {
      transition: transform .2s;
      display: inline-block;
    }

    .chevron.open {
      transform: rotate(90deg);
    }

    #log {
      max-height: 220px;
    }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .video-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      transition: transform .2s;
    }

    .video-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    }

    .video-thumb img {
      width: 100%;
      display: block;
    }

    .video-body {
      padding: 14px;
      display: grid;
      gap: 6px;
    }

    .video-title {
      font-weight: 700;
      line-height: 1.4;
      color: var(--text);
      text-decoration: none;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 2.8em;
    }

    .video-title:hover {
      text-decoration: underline;
      color: var(--primary);
    }

    .video-meta {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .video-actions {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .fav-btn {
      background: transparent;
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      color: var(--muted);
      transition: all .2s;
    }

    .fav-btn:hover {
      border-color: #fbbf24;
      color: #fbbf24;
    }

    .fav-btn.active {
      background: #fbbf24;
      color: #0b1220;
      border-color: #fbbf24;
    }

    .fav-section {
      border: 2px solid #fbbf24;
    }

    .fav-empty {
      text-align: center;
      color: var(--muted);
      padding: 20px;
    }

    .trend-chart {
      height: 200px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <header>
    <div>ğŸ“Š YouTube Shorts åˆ†æä»ªè¡¨æ¿</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <a href="favorites.html" class="secondary" style="text-decoration:none;display:inline-block;">â­ æˆ‘çš„æ”¶è—</a>
      <button id="exportBtn" class="secondary">å¯¼å‡ºæŠ¥å‘Š</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h3>è§¦å‘é‡‡é›†ï¼ˆè°ƒç”¨æœ¬åœ°åç«¯ /collectï¼‰</h3>
      <div class="row">
        <div>
          <label for="keywords">å…³é”®è¯</label>
          <input id="keywords" placeholder="ä¾‹å¦‚ï¼šRoblox" />
        </div>
        <div>
          <label for="maxResults">æ•°é‡ï¼ˆ1-10000ï¼‰</label>
          <input id="maxResults" type="number" value="20" min="1" max="10000" />
        </div>
        <div>
          <label for="days">æœ€è¿‘ N å¤©ï¼ˆé»˜è®¤ 7 å¤©ï¼‰</label>
          <input id="days" type="number" value="7" placeholder="é»˜è®¤ 7 å¤©" />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="collectBtn">ğŸš€ å¼€å§‹é‡‡é›†</button>
        <button id="clearLog" class="secondary">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div class="quick-pills" id="quickPills"></div>
      <div style="margin-top:12px;">
        <div class="log-header" id="logToggle">
          <span class="chevron" id="chevron">â–¶</span>
          <span>æ“ä½œæ—¥å¿—</span>
        </div>
        <pre id="log" style="display:none;"></pre>
      </div>
    </section>

    <section class="card">
      <h3>æ•°æ®æ¦‚è§ˆ</h3>
      <div class="cards" id="stats"></div>
    </section>

    <section class="card">
      <h3>çƒ­é—¨è§†é¢‘åˆ—è¡¨</h3>
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <label for="pageSize" style="margin:0;">æ¯é¡µæ˜¾ç¤º</label>
        <select id="pageSize" style="width:auto;">
          <option value="12" selected>12</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="video-grid" id="videoCards"></div>
      <div class="pagination">
        <button id="prevPage" class="secondary">ä¸Šä¸€é¡µ</button>
        <span id="pageInfo"></span>
        <button id="nextPage" class="secondary">ä¸‹ä¸€é¡µ</button>
      </div>
    </section>

    <section class="card">
      <h3>å¯è§†åŒ–</h3>
      <div class="charts">
        <div id="chart1" class="chart"></div>
        <div id="chart2" class="chart"></div>
        <div id="chart3" class="chart"></div>
        <div id="chart4" class="chart"></div>
        <div id="chart5" class="chart"></div>
        <div id="chart6" class="chart"></div>
        <div id="chart7" class="chart"></div>
        <div id="chart8" class="chart"></div>
      </div>
    </section>
  </main>

  <script src="./assets/echarts.min.js"></script>
  <script src="./assets/echarts-wordcloud.min.js"></script>
  <script>
    const LS_KEY = 'shorts_data';
    const backendBase = 'http://127.0.0.1:5000';
    const DEFAULT_KEYWORD = "";
    const DEFAULT_MAX = 20;
    const DEFAULT_DAYS = 7;
    const QUICK_PRESETS = [
      { label: 'kpop', keywords: ['rumi', 'mira', 'zoey', 'kpop'] },
    ];
    const logBox = document.getElementById('log');
    const chevron = document.getElementById('chevron');
    const logToggle = document.getElementById('logToggle');
    const collectBtn = document.getElementById('collectBtn');
    let logVisible = false;
    let cachedData = [];
    let charts = {};
    let pagination = { page: 1, pageSize: 12 };

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logBox.textContent += `[${time}] ${msg}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function toggleLog() {
      logVisible = !logVisible;
      logBox.style.display = logVisible ? 'block' : 'none';
      chevron.classList.toggle('open', logVisible);
    }

    function setCollecting(loading) {
      if (!collectBtn) return;
      collectBtn.disabled = loading;
      collectBtn.innerHTML = loading ? '<span class="gear-spin">âš™ï¸</span> é‡‡é›†ä¸­...' : 'ğŸš€ å¼€å§‹é‡‡é›†';
    }


    function fmtCompact(n) {
      const num = Number(n) || 0;
      if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
      if (num >= 1_000) return (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
      return num.toString();
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // ========== Favorites Functions ==========
    let favoritesData = [];

    async function loadFavorites() {
      try {
        const resp = await fetch(`${backendBase}/favorites`);
        if (!resp.ok) throw new Error('Failed to load favorites');
        const data = await resp.json();
        favoritesData = data.favorites || [];
        renderFavorites();
      } catch (err) {
        console.error('Load favorites error:', err);
      }
    }

    function renderFavorites() {
      const container = document.getElementById('favoritesGrid');
      const emptyEl = document.getElementById('favEmpty');
      const countEl = document.getElementById('favCount');

      if (!favoritesData.length) {
        container.innerHTML = '';
        emptyEl.style.display = 'block';
        countEl.textContent = '';
        return;
      }

      emptyEl.style.display = 'none';
      countEl.textContent = `(${favoritesData.length})`;

      container.innerHTML = favoritesData.map(item => {
        const url = `https://www.youtube.com/watch?v=${item.video_id}`;
        const thumb = `https://i.ytimg.com/vi/${item.video_id}/hqdefault.jpg`;
        const views = item.latest_view_count ? fmtCompact(item.latest_view_count) : '-';
        const created = (item.created_at || '').slice(0, 10);
        return `
        <div class="video-card">
          <a class="video-thumb" href="${url}" target="_blank">
            <img src="${thumb}" alt="${escapeHtml(item.title)}">
          </a>
          <div class="video-body">
            <a class="video-title" href="${url}" target="_blank">${escapeHtml(item.title)}</a>
            <div class="video-meta">é¢‘é“ï¼š${escapeHtml(item.channel_title || '')}</div>
            <div class="video-meta">ğŸ‘ï¸ ${views}</div>
            <div class="video-meta">æ”¶è—äºï¼š${created}</div>
            <div class="video-actions">
              <button class="fav-btn active" onclick="removeFavorite('${item.video_id}')">âŒ å–æ¶ˆæ”¶è—</button>
              <button class="fav-btn" onclick="showTrend('${item.video_id}')">ğŸ“ˆ è¶‹åŠ¿</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    async function toggleFavorite(btn) {
      const item = JSON.parse(btn.dataset.video);
      const isFav = favoritesData.some(f => f.video_id === item.video_id);

      if (isFav) {
        await removeFavorite(item.video_id);
      } else {
        try {
          const resp = await fetch(`${backendBase}/favorites`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              video_id: item.video_id,
              title: item.title,
              channel_id: item.channel_id,
              channel_title: item.channel_title,
              view_count: item.view_count,
              like_count: item.like_count,
              comment_count: item.comment_count
            })
          });
          if (resp.ok) {
            log(`å·²æ”¶è—ï¼š${item.title}`);
            btn.classList.add('active');
            btn.textContent = 'âœ… å·²æ”¶è—';
            await loadFavorites();
          }
        } catch (err) {
          log(`æ”¶è—å¤±è´¥ï¼š${err}`);
        }
      }
    }

    async function removeFavorite(videoId) {
      try {
        const resp = await fetch(`${backendBase}/favorites/${videoId}`, { method: 'DELETE' });
        if (resp.ok) {
          log(`å·²å–æ¶ˆæ”¶è—`);
          await loadFavorites();
        }
      } catch (err) {
        log(`å–æ¶ˆæ”¶è—å¤±è´¥ï¼š${err}`);
      }
    }

    async function showTrend(videoId) {
      try {
        const resp = await fetch(`${backendBase}/favorites/${videoId}/history`);
        if (!resp.ok) throw new Error('Failed to load history');
        const data = await resp.json();
        const history = data.history || [];

        if (!history.length) {
          alert('æš‚æ— å†å²æ•°æ®ï¼Œè¯·ç­‰å¾…å®šæ—¶ä»»åŠ¡æŠ“å–');
          return;
        }

        // Simple alert for now - could be enhanced with a modal chart
        const summary = history.slice(0, 5).map(h =>
          `${h.recorded_at.slice(0, 16)}: ${fmtCompact(h.view_count)}`
        ).join('\\n');
        alert(`æœ€è¿‘è§‚çœ‹é‡è®°å½•ï¼š\\n${summary}`);
      } catch (err) {
        alert('åŠ è½½å†å²æ•°æ®å¤±è´¥');
      }
    }

    function saveToLocalStorage(data) {
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      log(`å·²å†™å…¥ localStorageï¼Œå…± ${data.length} æ¡`);
    }

    function loadFromLocalStorage() {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }

    function renderStats(data) {
      const total = data.length;
      const views = data.reduce((s, v) => s + (+v.view_count || 0), 0);
      const likes = data.reduce((s, v) => s + (+v.like_count || 0), 0);
      const comments = data.reduce((s, v) => s + (+v.comment_count || 0), 0);
      const avgView = total ? Math.round(views / total) : 0;
      const avgLike = total ? Math.round(likes / total) : 0;
      const cards = [
        ['è§†é¢‘æ€»æ•°', total],
        ['è§‚çœ‹æ€»æ•°', fmtCompact(views)],
        ['ç‚¹èµæ€»æ•°', fmtCompact(likes)],
        ['è¯„è®ºæ€»æ•°', fmtCompact(comments)],
        ['å¹³å‡è§‚çœ‹', fmtCompact(avgView)],
        ['å¹³å‡ç‚¹èµ', fmtCompact(avgLike)]
      ];
      document.getElementById('stats').innerHTML = cards.map(([t, v]) => `
        <div class="stat"><div class="label">${t}</div><div class="value">${v}</div></div>
      `).join('');
    }

    function groupCount(arr, keyFn) {
      const m = new Map();
      arr.forEach(item => {
        const k = keyFn(item);
        if (!k) return;
        m.set(k, (m.get(k) || 0) + 1);
      });
      return [...m.entries()].sort((a, b) => b[1] - a[1]);
    }

    function renderCharts(data) {
      const viewSum = data.reduce((s, v) => s + (+v.view_count || 0), 0);
      const likeSum = data.reduce((s, v) => s + (+v.like_count || 0), 0);
      const commentSum = data.reduce((s, v) => s + (+v.comment_count || 0), 0);

      const durations = [0, 15, 30, 45, 60, 90];
      const durationBuckets = durations.slice(0, -1).map((start, i) => {
        const end = durations[i + 1];
        const count = data.filter(v => {
          const d = +v.duration_seconds || 0;
          return d >= start && d < end;
        }).length;
        return count;
      });

      const scatter = data.map(v => [+v.view_count || 0, +v.like_count || 0]);

      const byMonth = groupCount(data, v => (v.published_at || '').slice(0, 7));

      const channelCounts = (() => {
        const map = new Map();
        data.forEach(v => {
          const key = v.channel_id || v.channel_title || 'æœªçŸ¥';
          const title = v.channel_title || 'æœªçŸ¥';
          const count = map.get(key)?.count || 0;
          map.set(key, { title, channel_id: v.channel_id, count: count + 1 });
        });
        return [...map.entries()].map(([, val]) => val).sort((a, b) => b.count - a.count).slice(0, 10);
      })();;

      const tagCounts = (() => {
        const m = new Map();
        data.forEach(v => (v.tags || []).forEach(t => m.set(t, (m.get(t) || 0) + 1)));
        return [...m.entries()].map(([name, value]) => ({ name, value }));
      })();;

      const viewBuckets = (() => {
        const buckets = [
          { label: '<1k', min: 0, max: 1000 },
          { label: '1k-10k', min: 1000, max: 10000 },
          { label: '10k-100k', min: 10000, max: 100000 },
          { label: '100k-1M', min: 100000, max: 1000000 },
          { label: '>=1M', min: 1000000, max: Infinity },
        ];
        return buckets.map(b => ({
          name: b.label, value: data.filter(v => {
            const views = +v.view_count || 0;
            return views >= b.min && views < b.max;
          }).length
        }));
      })();;

      const radarMax = Math.max(
        viewSum, likeSum * 100, commentSum * 100
      ) || 1;

      const chartConfigs = [
        {
          id: 'chart1',
          option: {
            title: { text: 'äº’åŠ¨åˆ†å¸ƒ' },
            tooltip: {},
            xAxis: { type: 'category', data: ['è§‚çœ‹', 'ç‚¹èµ', 'è¯„è®º'] },
            yAxis: { type: 'value' },
            series: [{ type: 'bar', data: [viewSum, likeSum, commentSum], itemStyle: { color: '#437946' } }]
          }
        },
        {
          id: 'chart2',
          option: {
            title: { text: 'æ—¶é•¿åˆ†å¸ƒ(ç§’)' },
            tooltip: {},
            xAxis: { type: 'category', data: ['0-15', '15-30', '30-45', '45-60', '60-90'] },
            yAxis: { type: 'value' },
            series: [{ type: 'bar', data: durationBuckets, itemStyle: { color: '#2A9D8F' } }]
          }
        },
        {
          id: 'chart3',
          option: {
            title: { text: 'è§‚çœ‹-ç‚¹èµæ•£ç‚¹' },
            tooltip: { trigger: 'item' },
            xAxis: { type: 'value', name: 'è§‚çœ‹' },
            yAxis: { type: 'value', name: 'ç‚¹èµ' },
            series: [{ type: 'scatter', data: scatter, symbolSize: 6, itemStyle: { color: '#E76F51' } }]
          }
        },
        {
          id: 'chart4',
          option: {
            title: { text: 'å‘å¸ƒæ—¶é—´è¶‹åŠ¿' },
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: byMonth.map(d => d[0]) },
            yAxis: { type: 'value' },
            series: [{ type: 'line', data: byMonth.map(d => d[1]), smooth: true, areaStyle: { color: 'rgba(38, 70, 83, 0.2)' }, lineStyle: { color: '#264653' } }]
          },
          onClick: params => {
            if (params.name) {
              window.open(`analytics_detail.html?date=${params.name}`, '_blank');
            }
          }
        },
        {
          id: 'chart5',
          option: {
            title: { text: 'çƒ­é—¨é¢‘é“' },
            tooltip: {},
            xAxis: { type: 'value' },
            yAxis: { type: 'category', data: channelCounts.map(c => c.title).reverse() },
            series: [{ type: 'bar', data: channelCounts.map(c => c.count).reverse(), itemStyle: { color: '#E9C46A' } }]
          },
          onClick: params => {
            const index = channelCounts.length - 1 - params.dataIndex;
            const item = channelCounts[index];
            if (item && item.channel_id) {
              window.open(`https://www.youtube.com/channel/${item.channel_id}`, '_blank');
            }
          }
        },
        {
          id: 'chart6',
          option: {
            title: { text: 'æ ‡ç­¾è¯äº‘' },
            series: [{
              type: 'wordCloud',
              shape: 'circle',
              sizeRange: [12, 42],
              rotationRange: [0, 0],
              textStyle: { color: () => `hsl(${Math.random() * 60 + 100}, 50%, 40%)` },
              data: tagCounts.length ? tagCounts : [{ name: 'æš‚æ— æ ‡ç­¾', value: 1 }]
            }]
          }
        },
        {
          id: 'chart7',
          option: {
            title: { text: 'å‚ä¸åº¦é›·è¾¾' },
            tooltip: {},
            radar: {
              indicator: [
                { name: 'è§‚çœ‹', max: radarMax },
                { name: 'ç‚¹èµ', max: radarMax },
                { name: 'è¯„è®º', max: radarMax }
              ]
            },
            series: [{ type: 'radar', data: [{ value: [viewSum, likeSum, commentSum], areaStyle: { color: 'rgba(67, 121, 70, 0.4)' }, lineStyle: { color: '#437946' }, itemStyle: { color: '#437946' } }] }]
          }
        },
        {
          id: 'chart8',
          option: {
            title: { text: 'è§‚çœ‹åˆ†å¸ƒ' },
            tooltip: { trigger: 'item' },
            series: [{ type: 'pie', radius: ['30%', '70%'], data: viewBuckets }]
          }
        },
      ];

      chartConfigs.forEach(cfg => {
        const dom = document.getElementById(cfg.id);
        if (!dom) return;
        if (charts[cfg.id]) {
          charts[cfg.id].dispose();
        }
        const inst = echarts.init(dom, null, { renderer: 'canvas' });
        inst.setOption(cfg.option);
        if (cfg.onClick) inst.on('click', cfg.onClick);
        charts[cfg.id] = inst;
      });
    }

    function renderCards(data) {
      const start = (pagination.page - 1) * pagination.pageSize;
      const end = start + pagination.pageSize;
      const slice = data.slice(start, end);
      const container = document.getElementById('videoCards');
      container.innerHTML = slice.map(item => {
        const url = item.video_id ? `https://www.youtube.com/watch?v=${item.video_id}` : '#';
        const thumb = item.video_id ? `https://i.ytimg.com/vi/${item.video_id}/hqdefault.jpg` : '';
        const views = fmtCompact(item.view_count);
        const likes = fmtCompact(item.like_count);
        const comments = fmtCompact(item.comment_count);
        const published = (item.published_at || '').replace('T', ' ').replace('Z', '');
        return `
        <div class="video-card">
          <a class="video-thumb" href="${url}" target="_blank" rel="noopener noreferrer">
            <img src="${thumb}" alt="${escapeHtml(item.title || '')}">
          </a>
          <div class="video-body">
            <a class="video-title" href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(item.title || '')}</a>
            <div class="video-meta">é¢‘é“ï¼š${escapeHtml(item.channel_title || '')}</div>
            <div class="video-meta">ğŸ‘ï¸ ${views} Â· ğŸ‘ ${likes} Â· ğŸ’¬ ${comments}</div>
            <div class="video-meta">å‘å¸ƒæ—¶é—´ï¼š${published}</div>
            <div class="video-actions">
              <button class="fav-btn" data-video='${JSON.stringify(item).replace(/'/g, "&#39;")}' onclick="toggleFavorite(this)">â­ æ”¶è—</button>
            </div>
          </div>
        </div>`;
      }).join('');
      const totalPages = Math.max(1, Math.ceil(data.length / pagination.pageSize));
      document.getElementById('pageInfo').textContent = `ç¬¬ ${pagination.page} / ${totalPages} é¡µ`;
      document.getElementById('prevPage').disabled = pagination.page <= 1;
      document.getElementById('nextPage').disabled = pagination.page >= totalPages;
    }

    function updateAll(data) {
      const sorted = [...data].sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
      cachedData = sorted;
      renderStats(sorted);
      renderCharts(sorted);
      renderCards(sorted);
    }
    async function triggerCollect(isAuto = false, keywordList = null) {
      const keywordsInput = document.getElementById('keywords');
      const daysInput = document.getElementById('days');
      const keywords = keywordsInput.value.trim();
      const max_results = parseInt(document.getElementById('maxResults').value, 10) || DEFAULT_MAX;
      const daysRaw = daysInput.value;
      const days = daysRaw === '' ? DEFAULT_DAYS : Number(daysRaw);
      const kwList = Array.isArray(keywordList) && keywordList.length ? keywordList : (keywords ? [keywords] : []);
      if (!kwList.length) { log('è¯·è¾“å…¥å…³é”®è¯'); return; }
      const payload = { max_results, days };
      if (Array.isArray(keywordList) && keywordList.length) {
        payload.keyword_list = keywordList;
      } else {
        payload.keywords = keywords;
      }
      log(`å¼€å§‹é‡‡é›†ï¼š${kwList.join(' / ')}, max=${max_results}, days=${days}`);
      try {
        setCollecting(true);
        const resp = await fetch(`${backendBase}/collect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) {
          log(`é‡‡é›†å¤±è´¥ï¼š${data.error || resp.status}`);
          return;
        }
        log(`é‡‡é›†å®Œæˆï¼šå…± ${data.total} æ¡ï¼Œå·²å†™å…¥ ${data.data_file}`);
        await loadData();
      } catch (err) {
        log(`è¯·æ±‚å¤±è´¥ï¼š${err}`);
      } finally {
        setCollecting(false);
      }
    }

    async function loadData() {
      try {
        const res = await fetch('./shorts.json');
        if (!res.ok) { log('è¯»å– shorts.json å¤±è´¥'); return false; }
        const json = await res.json();
        saveToLocalStorage(json);
        updateAll(json);
        return true;
      } catch (err) {
        log(`åŠ è½½å¤±è´¥ï¼š${err}`);
        return false;
      }
    }

    function exportReport() {
      const data = cachedData;
      if (!data.length) { log('æ— æ•°æ®å¯å¯¼å‡º'); return; }
      const total = data.length;
      const views = data.reduce((s, v) => s + (+v.view_count || 0), 0);
      const likes = data.reduce((s, v) => s + (+v.like_count || 0), 0);
      const comments = data.reduce((s, v) => s + (+v.comment_count || 0), 0);
      const stats = { total, views, likes, comments };
      const topVideos = [...data].sort((a, b) => (b.view_count || 0) - (a.view_count || 0)).slice(0, 20);
      const topChannels = groupCount(data, v => v.channel_title || 'æœªçŸ¥').slice(0, 10)
        .map(([channel, count]) => ({ channel, count }));
      const tagMap = new Map();
      data.forEach(v => (v.tags || []).forEach(t => tagMap.set(t, (tagMap.get(t) || 0) + 1)));
      const topTags = [...tagMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 20)
        .map(([tag, count]) => ({ tag, count }));
      const payload = { generated_at: new Date().toISOString(), stats, topVideos, topChannels, topTags };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'report.json'; a.click();
      URL.revokeObjectURL(url);
      log('å·²å¯¼å‡º report.json');
    }

    function renderQuickPills() {
      const box = document.getElementById('quickPills');
      if (!box) return;
      box.innerHTML = QUICK_PRESETS.map((preset, idx) => `
        <button class="pill" data-idx="${idx}">${preset.label}</button>
      `).join('');
      box.querySelectorAll('.pill').forEach(btn => {
        btn.onclick = () => {
          const preset = QUICK_PRESETS[Number(btn.dataset.idx)];
          if (!preset) return;
          document.getElementById('keywords').value = preset.keywords.join(' / ');
          triggerCollect(false, preset.keywords);
        };
      });
    }

    document.getElementById('collectBtn').onclick = triggerCollect;
    document.getElementById('exportBtn').onclick = exportReport;
    document.getElementById('clearLog').onclick = () => { logBox.textContent = ''; };
    document.getElementById('logToggle').onclick = toggleLog;
    document.getElementById('prevPage').onclick = () => { if (pagination.page > 1) { pagination.page--; renderCards(cachedData); } };
    document.getElementById('nextPage').onclick = () => {
      const totalPages = Math.max(1, Math.ceil(cachedData.length / pagination.pageSize));
      if (pagination.page < totalPages) { pagination.page++; renderCards(cachedData); }
    };
    document.getElementById('pageSize').onchange = (e) => {
      pagination.pageSize = Number(e.target.value);
      pagination.page = 1;
      renderCards(cachedData);
    };

    (function init() {
      const local = loadFromLocalStorage();
      if (local.length) {
        log(`å·²ä» localStorage è¯»å– ${local.length} æ¡`);
        updateAll(local);
      } else {
        log('localStorage æ— æ•°æ®ï¼Œè¯·è¾“å…¥å…³é”®è¯é‡‡é›†');
      }
      renderQuickPills();
      loadFavorites();
    })();;
  </script>
</body>

</html>