<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>YouTube Shorts ÂàÜÊûê‰ª™Ë°®Êùø</title>
  <link rel="icon" href="./assets/logo.svg" type="image/svg+xml">
  <style>
    :root {
      --bg: #F0EFEA;
      /* Warm letter paper background */
      --panel: #F7F6F2;
      /* Slightly lighter card bg */
      --muted: #888880;
      --text: #2C2C2A;
      /* Softer black */
      --primary: #437946;
      --border: #E6E4DC;
      --font-serif: "Georgia", "Times New Roman", serif;
      --font-sans: "Inter", "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: #c9c5b7 var(--bg);
    }

    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background-color: #c9c5b7;
      border-radius: 999px;
      border: 3px solid var(--bg);
    }

    html {
      font-size: 16px;
      /* Base size */
    }

    body {
      margin: 0;
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-family: var(--font-serif);
      font-weight: 600;
      color: #1A1A18;
      line-height: 1.2;
      margin-top: 0;
    }

    h1 {
      font-size: 1.5rem;
    }

    h2 {
      font-size: 1.375rem;
    }

    h3 {
      font-size: 1.25rem;
    }

    header {
      padding: 1rem 1.5rem;
      background: rgba(240, 239, 234, 0.85);
      /* Matches --bg with transparency */
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.03);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.625rem 1.125rem;
      /* 10px 18px -> ~0.625rem 1.125rem */
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s, transform 0.1s;
    }

    button:hover {
      opacity: 0.95;
      transform: translateY(-1px);
    }

    button.secondary,
    a.secondary {
      background: #E2E0D6;
      color: var(--text);
      border: none;
      padding: 0.625rem 1.125rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.875rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
      transition: background 0.2s, transform 0.1s;
    }

    button.secondary:hover,
    a.secondary:hover {
      background: #D6D4CA;
    }

    main {
      padding: 1rem 1.5rem;
      display: grid;
      gap: 1rem;
    }

    .card {
      background: var(--panel);
      border-radius: 1.5rem;
      /* 24px */
      padding: 1.5rem;
      box-shadow:
        0 4px 6px -1px rgba(67, 121, 70, 0.03),
        0 2px 4px -1px rgba(0, 0, 0, 0.02),
        inset 0 0 0 1px #FFF;
      /* Subtle inner highlight */
      border: 1px solid var(--border);
    }

    label {
      display: block;
      margin-bottom: 0.375rem;
      /* 6px */
      font-size: 0.75rem;
      /* 12px */
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--muted);
      text-transform: uppercase;
    }

    input,
    select {
      width: 100%;
      padding: 0.625rem 0.75rem;
      /* 10px 12px */
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      /* 12px */
      background: #FDFDFB;
      color: var(--text);
      font-size: 0.9375rem;
      /* 15px */
      font-family: var(--font-sans);
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(67, 121, 70, 0.1);
    }

    .row {
      display: grid;
      gap: 0.75rem;
      /* 12px */
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #2D2D2A;
      color: #E0E0D6;
      padding: 1rem;
      border-radius: 0.75rem;
      /* 12px */
      border: none;
      max-height: 13.75rem;
      /* 220px */
      overflow: auto;
      font-family: monospace;
      font-size: 0.8125rem;
      /* 13px */
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      /* 12px */
    }

    .stat {
      padding: 1rem;
      border-radius: 1rem;
      /* 16px */
      background: #EBE9E2;
      border: 1px solid transparent;
    }

    .stat .label {
      color: var(--muted);
      font-size: 0.8125rem;
      /* 13px */
    }

    .stat .value {
      font-size: 1.375rem;
      /* 22px */
      font-weight: 700;
      margin-top: 0.25rem;
      color: var(--primary);
    }

    .quick-pills {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.625rem;
      /* 10px */
    }

    .pill {
      padding: 0.375rem 0.875rem;
      /* 6px 14px */
      border-radius: 999px;
      /* Refined Pill Style */
      background: rgba(67, 121, 70, 0.1);
      color: var(--primary);
      border: 1px solid transparent;
      /* No visible border initially */
      cursor: pointer;
      font-size: 0.75rem;
      /* 12px */
      font-weight: 600;
      letter-spacing: 0.01em;
      transition: all .2s;
    }

    .pill:hover {
      background: rgba(67, 121, 70, 0.2);
      color: var(--primary);
      transform: translateY(-1px);
    }

    .gear-spin {
      display: inline-block;
      animation: gearSpin 1s linear infinite;
      transform-origin: 50% 50%;
    }

    @keyframes gearSpin {
      to {
        transform: rotate(360deg);
      }
    }

    .charts {
      display: grid;
      gap: 1rem;
      /* 16px roughly */
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .chart {
      height: 20rem;
      /* 320px */
      border-radius: 0.75rem;
      /* 12px */
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text);
    }

    th,
    td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      color: var(--muted);
      font-weight: 600;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.625rem;
      /* 10px */
    }

    a.link {
      color: #38bdf8;
      text-decoration: none;
    }

    a.link:hover {
      text-decoration: underline;
    }

    .log-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
    }

    .chevron {
      transition: transform .2s;
      display: inline-block;
    }

    .chevron.open {
      transform: rotate(90deg);
    }

    #log {
      max-height: 13.75rem;
      /* 220px */
    }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.75rem;
      /* 12px */
    }

    .video-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 1rem;
      /* 16px */
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      transition: transform .2s, box-shadow .2s;
    }

    .video-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
    }

    .video-thumb img {
      width: 100%;
      display: block;
    }

    .video-body {
      padding: 0.875rem;
      /* 14px */
      display: grid;
      gap: 0.375rem;
      /* 6px */
    }

    .video-title {
      font-weight: 700;
      line-height: 1.4;
      color: var(--text);
      text-decoration: none;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 2.8em;
    }

    .video-title:hover {
      text-decoration: underline;
      color: var(--primary);
    }

    .video-meta {
      font-size: 0.8125rem;
      /* 13px */
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .video-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.375rem;
    }

    .fav-btn {
      background: transparent;
      border: 1px solid var(--border);
      padding: 0.25rem 0.5rem;
      /* 4px 8px */
      border-radius: 0.25rem;
      font-size: 0.75rem;
      /* 12px */
      cursor: pointer;
      color: var(--muted);
      transition: all .2s;
    }

    .fav-btn:hover {
      border-color: #fbbf24;
      color: #fbbf24;
    }

    .fav-btn.active {
      background: #fbbf24;
      color: #0b1220;
      border-color: #fbbf24;
    }

    .fav-section {
      border: 2px solid #fbbf24;
    }

    .fav-empty {
      text-align: center;
      color: var(--muted);
      padding: 1.25rem;
    }

    .trend-chart {
      height: 12.5rem;
      /* 200px */
      margin-top: 0.625rem;
      /* 10px */
    }

    /* Utilities */
    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .flex-wrap {
      flex-wrap: wrap;
    }

    .gap-1 {
      gap: 0.25rem;
    }

    /* 4px */
    .gap-2 {
      gap: 0.5rem;
    }

    /* 8px */
    .gap-3 {
      gap: 0.75rem;
    }

    /* 12px */
    .gap-4 {
      gap: 1rem;
    }

    /* 16px */
    .mt-2 {
      margin-top: 0.5rem;
    }

    .mt-3 {
      margin-top: 0.75rem;
    }

    .mt-4 {
      margin-top: 1rem;
    }

    .mb-0 {
      margin-bottom: 0;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .w-full {
      width: 100%;
    }

    .w-auto {
      width: auto;
    }

    .inline-block {
      display: inline-block;
    }

    .no-underline {
      text-decoration: none;
    }
  </style>
</head>

<body>
  <header>
    <div class="flex items-center gap-2">
      <img src="./assets/logo.svg" alt="Logo" style="width: 2.24rem; height: auto;">
      <div style="font-weight: 700; font-size: 1.125rem;">YouTube Shorts ÂàÜÊûê‰ª™Ë°®Êùø</div>
    </div>
    <div class="flex gap-2 flex-wrap items-center">
      <button id="exportBtn" class="secondary">ÂØºÂá∫Êä•Âëä</button>
      <a href="favorites.html" class="secondary no-underline inline-block">‚≠ê ÊàëÁöÑÊî∂Ëóè</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h4 style="font-weight: 700; display: flex; align-items: center; gap: 0.5rem;"><svg width="18" height="18"
          viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
        </svg>Êï∞ÊçÆÈááÈõÜ</h4>
      <div class="row">
        <div>
          <label for="keywords">ÂÖ≥ÈîÆËØç</label>
          <input id="keywords" placeholder="‰æãÂ¶ÇÔºöRoblox" />
        </div>
        <div>
          <label for="maxResults">Êï∞ÈáèÔºà1-10000Ôºâ</label>
          <input id="maxResults" type="number" value="20" min="1" max="10000" />
        </div>
        <div class="input-group">
          <label for="days">ÊúÄËøë N Â§©ÔºàÈªòËÆ§ 3 Â§©Ôºâ</label>
          <input type="number" id="days" placeholder="3" />
        </div>
      </div>
      <div class="quick-pills" id="quickPills"></div>
      <div class="mt-3 flex gap-2 flex-wrap">
        <button id="collectBtn">üöÄ ÂºÄÂßãÈááÈõÜ</button>
      </div>
      <div class="mt-4">
        <div class="log-header" id="logToggle"
          style="display:flex; align-items:center; color: var(--muted); font-size: 0.8125rem;">
          <span class="chevron" id="chevron">‚ñ∂</span>
          <span style="font-weight:600; margin-left:4px;">Êìç‰ΩúÊó•Âøó</span>
          <button id="clearLog" class="secondary"
            style="margin-left: auto; padding: 4px 12px; font-size: 12px; height: auto; background: rgba(255,255,255,0.9); border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: none;">Ê∏ÖÁ©∫Êó•Âøó</button>
        </div>
        <pre id="log" style="display:none; margin-top: 12px; padding: 1rem; border: 1px solid var(--border);"></pre>
      </div>
    </section>

    <section class="card">
      <h4 style="font-weight: 700; display: flex; align-items: center; gap: 0.5rem;"><svg width="18" height="18"
          viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7" />
          <rect x="14" y="3" width="7" height="7" />
          <rect x="14" y="14" width="7" height="7" />
          <rect x="3" y="14" width="7" height="7" />
        </svg>Êï∞ÊçÆÊ¶ÇËßà</h4>
      <div class="cards" id="stats"></div>
    </section>

    <section class="card">
      <h4 style="font-weight: 700; display: flex; align-items: center; gap: 0.5rem;"><svg width="18" height="18"
          viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="8" y1="6" x2="21" y2="6" />
          <line x1="8" y1="12" x2="21" y2="12" />
          <line x1="8" y1="18" x2="21" y2="18" />
          <line x1="3" y1="6" x2="3.01" y2="6" />
          <line x1="3" y1="12" x2="3.01" y2="12" />
          <line x1="3" y1="18" x2="3.01" y2="18" />
        </svg>ÁÉ≠Èó®ËßÜÈ¢ëÂàóË°®</h4>
      <div class="flex items-center gap-2 mb-2">
        <label for="pageSize" class="mb-0">ÊØèÈ°µÊòæÁ§∫</label>
        <select id="pageSize" class="w-auto">
          <option value="12">12</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="video-grid" id="videoCards"></div>
      <div class="pagination">
        <button id="prevPage" class="secondary">‰∏ä‰∏ÄÈ°µ</button>
        <span id="pageInfo"></span>
        <button id="nextPage" class="secondary">‰∏ã‰∏ÄÈ°µ</button>
      </div>
    </section>

    <section class="card">
      <h4 style="font-weight: 700; display: flex; align-items: center; gap: 0.5rem;"><svg width="18" height="18"
          viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="20" x2="18" y2="10" />
          <line x1="12" y1="20" x2="12" y2="4" />
          <line x1="6" y1="20" x2="6" y2="14" />
        </svg>ÂèØËßÜÂåñ</h4>
      <div class="charts">
        <div id="chart1" class="chart"></div>
        <div id="chart2" class="chart"></div>
        <div id="chart3" class="chart"></div>
        <div id="chart4" class="chart"></div>
        <div id="chart5" class="chart"></div>
        <div id="chart6" class="chart"></div>
        <div id="chart7" class="chart"></div>
        <div id="chart8" class="chart"></div>
      </div>
    </section>
  </main>

  <script src="./assets/echarts.min.js"></script>
  <script src="./assets/echarts-wordcloud.min.js"></script>
  <script>
    const LS_KEY = 'shorts_data';
    const backendBase = 'http://127.0.0.1:5000';
    const DEFAULT_KEYWORD = "";
    const DEFAULT_MAX = 20;
    const DEFAULT_DAYS = 3;
    const QUICK_PRESETS = [
      { label: 'common words', keywords: ['a|about|after|already|also|although|always|am|an|and|are|as|at|back|be|because|best|between|big|but|by|came|can|cat|come|could|day|did|do|dog|even|find|first|for|found|from|gave|get|give|go|good|got|great|had|have|he|her|here|him|how|i|if|in|into|is|it|just|knew|know|last|let|life|like|little|long|look|made|make|man|may|me|might|more|must|need|never|new|not|now|of|old|on|one|only|or|other|out|over|people|really|right|said|saw|say|see|she|shorts|should|show|so|still|story|take|tell|that|the|them|then|there|these|they|thing|think|this|those|thought|through|time|to|told|too|took|trend|try|two|use|very|want|was|way|we|well|went|were|what|when|where|which|while|who|why|will|with|woman|work|world|would|year|you'] },
      { label: 'the', keywords: ['the'] },
      { label: 'be', keywords: ['be|am|is|are|was|were'] },
      { label: 'to', keywords: ['to'] },
      { label: 'of', keywords: ['of'] },
      { label: 'and', keywords: ['and'] },
      { label: 'a', keywords: ['a'] },
      { label: 'in', keywords: ['in'] },
      { label: 'that', keywords: ['that'] },
      { label: 'have', keywords: ['have'] },
      { label: 'i', keywords: ['i'] },
      { label: 'it', keywords: ['it'] },
      { label: 'for', keywords: ['for'] },
      { label: 'not', keywords: ['not'] },
      { label: 'on', keywords: ['on'] },
      { label: 'with', keywords: ['with'] },
      { label: 'he', keywords: ['he'] },
      { label: 'as', keywords: ['as'] },
      { label: 'you', keywords: ['you'] },
      { label: 'do', keywords: ['do'] },
      { label: 'at', keywords: ['at'] },
      { label: 'kpop set', keywords: ['rumi', 'mira', 'zoey', 'kpop', 'jinu'] },
      { label: 'jinu', keywords: ['jinu'] },
      { label: 'rumi', keywords: ['rumi'] },
      { label: 'mira', keywords: ['mira'] },
      { label: 'zoey', keywords: ['zoey'] },
      { label: 'kpop', keywords: ['kpop'] },
    ];
    const logBox = document.getElementById('log');
    const chevron = document.getElementById('chevron');
    const logToggle = document.getElementById('logToggle');
    const collectBtn = document.getElementById('collectBtn');
    let logVisible = false;
    let cachedData = [];
    let charts = {};
    let pagination = { page: 1, pageSize: 20 };

    const CHART_COLORS = {
      primary: '#437946',
      teal: '#2A9D8F',
      orange: '#E76F51',
      yellow: '#E9C46A',
      secondary: '#264653',
      line: '#264653',
      area: 'rgba(38, 70, 83, 0.2)',
      radarArea: 'rgba(67, 121, 70, 0.4)'
    };

    // Shared chart styling for consistent UX
    const CHART_STYLE = {
      title: {
        left: 'center',
        top: 16,
        textStyle: { fontSize: 16, fontWeight: 600, color: '#2D2D2A' }
      },
      grid: { left: 56, right: 24, top: 56, bottom: 48 },
      gridWide: { left: 120, right: 24, top: 56, bottom: 48 }, // For horizontal bar charts
      // For non-axis charts (wordCloud, radar, pie)
      centerContent: {
        center: ['50%', '55%'],
        radius: '65%'
      },
      tooltip: {
        backgroundColor: 'rgba(255,255,255,0.95)',
        borderColor: '#E0E0D6',
        textStyle: { color: '#2D2D2A', fontSize: 13 }
      },
      axisLine: { lineStyle: { color: '#C8C8BE' } },
      axisLabel: { color: '#5A5A52', fontSize: 12 },
      nameTextStyle: { color: '#5A5A52', fontSize: 13 },
      splitLine: { lineStyle: { color: '#E8E8E0', type: 'dashed' } },
      barStyle: { barWidth: '50%', borderRadius: [4, 4, 0, 0] },
      barStyleHorizontal: { barWidth: '50%', borderRadius: [0, 4, 4, 0] }
    };

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logBox.textContent += `[${time}] ${msg}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function toggleLog() {
      logVisible = !logVisible;
      logBox.style.display = logVisible ? 'block' : 'none';
      document.getElementById('clearLog').style.display = logVisible ? 'block' : 'none'; // Sync button visibility
      logToggle.classList.toggle('active', logVisible);
      chevron.classList.toggle('open', logVisible);
    }

    function setCollecting(loading) {
      if (!collectBtn) return;
      collectBtn.disabled = loading;
      collectBtn.innerHTML = loading ? '<span class="gear-spin">‚öôÔ∏è</span> ÈááÈõÜ‰∏≠...' : 'üöÄ ÂºÄÂßãÈááÈõÜ';
    }


    function fmtCompact(n) {
      const num = Number(n) || 0;
      if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
      if (num >= 1_000) return (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
      return num.toString();
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // ========== Favorites Functions ==========
    let favoritesData = [];

    async function loadFavorites() {
      try {
        const resp = await fetch(`${backendBase}/favorites`);
        if (!resp.ok) throw new Error('Failed to load favorites');
        const data = await resp.json();
        favoritesData = data.favorites || [];
        renderFavorites();
      } catch (err) {
        console.error('Load favorites error:', err);
      }
    }

    function renderFavorites() {
      const container = document.getElementById('favoritesGrid');
      const emptyEl = document.getElementById('favEmpty');
      const countEl = document.getElementById('favCount');

      if (!favoritesData.length) {
        container.innerHTML = '';
        emptyEl.style.display = 'block';
        countEl.textContent = '';
        return;
      }

      emptyEl.style.display = 'none';
      countEl.textContent = `(${favoritesData.length})`;

      container.innerHTML = favoritesData.map(item => {
        const url = `https://www.youtube.com/watch?v=${item.video_id}`;
        const thumb = `https://i.ytimg.com/vi/${item.video_id}/hqdefault.jpg`;
        const views = item.latest_view_count ? fmtCompact(item.latest_view_count) : '-';
        const created = (item.created_at || '').slice(0, 10);
        return `
        <div class="video-card">
          <a class="video-thumb" href="${url}" target="_blank">
            <img src="${thumb}" alt="${escapeHtml(item.title)}">
          </a>
          <div class="video-body">
            <a class="video-title" href="${url}" target="_blank">${escapeHtml(item.title)}</a>
            <div class="video-meta"><span>È¢ëÈÅìÔºö<a href="https://www.youtube.com/channel/${item.channel_id}" target="_blank" rel="noopener noreferrer" style="color: inherit;">${escapeHtml(item.channel_title || '')}</a></span></div>
            <div class="video-meta">üëÅÔ∏è ${views}</div>
            <div class="video-meta">Êî∂Ëóè‰∫éÔºö${created}</div>
            <div class="video-actions">
              <button class="fav-btn active" onclick="removeFavorite('${item.video_id}')">‚ùå ÂèñÊ∂àÊî∂Ëóè</button>
              <button class="fav-btn" onclick="showTrend('${item.video_id}')">üìà Ë∂ãÂäø</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    async function toggleFavorite(btn) {
      const item = JSON.parse(btn.dataset.video);
      const isFav = favoritesData.some(f => f.video_id === item.video_id);

      if (isFav) {
        await removeFavorite(item.video_id);
      } else {
        try {
          const resp = await fetch(`${backendBase}/favorites`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              video_id: item.video_id,
              title: item.title,
              channel_id: item.channel_id,
              channel_title: item.channel_title,
              view_count: item.view_count,
              like_count: item.like_count,
              comment_count: item.comment_count,
              published_at: item.published_at
            })
          });
          if (resp.ok) {
            log(`Â∑≤Êî∂ËóèÔºö${item.title}`);
            btn.classList.add('active');
            btn.textContent = '‚úÖ Â∑≤Êî∂Ëóè';
            await loadFavorites();
          }
        } catch (err) {
          log(`Êî∂ËóèÂ§±Ë¥•Ôºö${err}`);
        }
      }
    }

    async function removeFavorite(videoId) {
      try {
        const resp = await fetch(`${backendBase}/favorites/${videoId}`, { method: 'DELETE' });
        if (resp.ok) {
          log(`Â∑≤ÂèñÊ∂àÊî∂Ëóè`);
          await loadFavorites();
        }
      } catch (err) {
        log(`ÂèñÊ∂àÊî∂ËóèÂ§±Ë¥•Ôºö${err}`);
      }
    }

    async function showTrend(videoId) {
      try {
        const resp = await fetch(`${backendBase}/favorites/${videoId}/history`);
        if (!resp.ok) throw new Error('Failed to load history');
        const data = await resp.json();
        const history = data.history || [];

        if (!history.length) {
          alert('ÊöÇÊó†ÂéÜÂè≤Êï∞ÊçÆÔºåËØ∑Á≠âÂæÖÂÆöÊó∂‰ªªÂä°ÊäìÂèñ');
          return;
        }

        // Simple alert for now - could be enhanced with a modal chart
        const summary = history.slice(0, 5).map(h =>
          `${h.recorded_at.slice(0, 16)}: ${fmtCompact(h.view_count)}`
        ).join('\\n');
        alert(`ÊúÄËøëËßÇÁúãÈáèËÆ∞ÂΩïÔºö\\n${summary}`);
      } catch (err) {
        alert('Âä†ËΩΩÂéÜÂè≤Êï∞ÊçÆÂ§±Ë¥•');
      }
    }

    function saveToLocalStorage(data) {
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      log(`Â∑≤ÂÜôÂÖ• localStorageÔºåÂÖ± ${data.length} Êù°`);
    }

    function loadFromLocalStorage() {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }

    function renderStats(data) {
      const total = data.length;
      const views = data.reduce((s, v) => s + (+v.view_count || 0), 0);
      const likes = data.reduce((s, v) => s + (+v.like_count || 0), 0);
      const comments = data.reduce((s, v) => s + (+v.comment_count || 0), 0);
      const avgView = total ? Math.round(views / total) : 0;
      const avgLike = total ? Math.round(likes / total) : 0;
      const cards = [
        ['ËßÜÈ¢ëÊÄªÊï∞', total],
        ['ËßÇÁúãÊÄªÊï∞', fmtCompact(views)],
        ['ÁÇπËµûÊÄªÊï∞', fmtCompact(likes)],
        ['ËØÑËÆ∫ÊÄªÊï∞', fmtCompact(comments)],
        ['Âπ≥ÂùáËßÇÁúã', fmtCompact(avgView)],
        ['Âπ≥ÂùáÁÇπËµû', fmtCompact(avgLike)]
      ];
      document.getElementById('stats').innerHTML = cards.map(([t, v]) => `
        <div class="stat"><div class="label">${t}</div><div class="value">${v}</div></div>
      `).join('');
    }

    function groupCount(arr, keyFn) {
      const m = new Map();
      arr.forEach(item => {
        const k = keyFn(item);
        if (!k) return;
        m.set(k, (m.get(k) || 0) + 1);
      });
      return [...m.entries()].sort((a, b) => b[1] - a[1]);
    }

    function renderCharts(data) {
      const viewSum = data.reduce((s, v) => s + (+v.view_count || 0), 0);
      const likeSum = data.reduce((s, v) => s + (+v.like_count || 0), 0);
      const commentSum = data.reduce((s, v) => s + (+v.comment_count || 0), 0);

      const durations = [0, 15, 30, 45, 60, 90];
      const durationBuckets = durations.slice(0, -1).map((start, i) => {
        const end = durations[i + 1];
        const count = data.filter(v => {
          const d = +v.duration_seconds || 0;
          return d >= start && d < end;
        }).length;
        return count;
      });

      const scatter = data.map(v => [+v.view_count || 0, +v.like_count || 0]);

      const byMonth = groupCount(data, v => (v.published_at || '').slice(0, 7));

      const channelCounts = (() => {
        const map = new Map();
        data.forEach(v => {
          const key = v.channel_id || v.channel_title || 'Êú™Áü•';
          const title = v.channel_title || 'Êú™Áü•';
          const count = map.get(key)?.count || 0;
          map.set(key, { title, channel_id: v.channel_id, count: count + 1 });
        });
        return [...map.entries()].map(([, val]) => val).sort((a, b) => b.count - a.count).slice(0, 10);
      })();;

      const tagCounts = (() => {
        const m = new Map();
        data.forEach(v => (v.tags || []).forEach(t => m.set(t, (m.get(t) || 0) + 1)));
        return [...m.entries()].map(([name, value]) => ({ name, value }));
      })();;

      const viewBuckets = (() => {
        const buckets = [
          { label: '<1k', min: 0, max: 1000 },
          { label: '1k-10k', min: 1000, max: 10000 },
          { label: '10k-100k', min: 10000, max: 100000 },
          { label: '100k-1M', min: 100000, max: 1000000 },
          { label: '>=1M', min: 1000000, max: Infinity },
        ];
        return buckets.map(b => ({
          name: b.label, value: data.filter(v => {
            const views = +v.view_count || 0;
            return views >= b.min && views < b.max;
          }).length
        }));
      })();;

      const radarMax = Math.max(
        viewSum, likeSum * 100, commentSum * 100
      ) || 1;

      const chartConfigs = [
        {
          id: 'chart1',
          option: {
            title: { text: '‰∫íÂä®ÂàÜÂ∏É', ...CHART_STYLE.title },
            tooltip: {
              trigger: 'axis',
              axisPointer: { type: 'shadow' },
              ...CHART_STYLE.tooltip,
              formatter: params => {
                const p = params[0];
                const fmt = v => v >= 1e9 ? (v / 1e9).toFixed(2) + 'B' : v >= 1e6 ? (v / 1e6).toFixed(1) + 'M' : v >= 1e3 ? (v / 1e3).toFixed(0) + 'K' : v;
                return `<strong>${p.name}</strong><br/>${fmt(p.value)} (${p.value.toLocaleString()})`;
              }
            },
            grid: { ...CHART_STYLE.grid, left: 72 },
            xAxis: {
              type: 'category',
              data: ['ËßÇÁúã', 'ÁÇπËµû', 'ËØÑËÆ∫'],
              axisLine: CHART_STYLE.axisLine,
              axisLabel: { ...CHART_STYLE.axisLabel, fontSize: 13 }
            },
            yAxis: {
              type: 'log',
              min: 1,
              axisLine: { show: false },
              splitLine: CHART_STYLE.splitLine,
              axisLabel: {
                ...CHART_STYLE.axisLabel,
                formatter: val => val >= 1e9 ? (val / 1e9).toFixed(0) + 'B' : val >= 1e6 ? (val / 1e6).toFixed(0) + 'M' : val >= 1e3 ? (val / 1e3).toFixed(0) + 'K' : val
              }
            },
            series: [{
              type: 'bar',
              data: [viewSum, likeSum, commentSum],
              ...CHART_STYLE.barStyle,
              itemStyle: { color: CHART_COLORS.primary, borderRadius: [4, 4, 0, 0] },
              label: {
                show: true,
                position: 'top',
                ...CHART_STYLE.axisLabel,
                fontSize: 11,
                formatter: p => p.value >= 1e9 ? (p.value / 1e9).toFixed(1) + 'B' : p.value >= 1e6 ? (p.value / 1e6).toFixed(1) + 'M' : p.value >= 1e3 ? (p.value / 1e3).toFixed(0) + 'K' : p.value
              }
            }]
          }
        },
        {
          id: 'chart2',
          option: {
            title: { text: 'Êó∂ÈïøÂàÜÂ∏É(Áßí)', ...CHART_STYLE.title },
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, ...CHART_STYLE.tooltip },
            grid: CHART_STYLE.grid,
            xAxis: { type: 'category', data: ['0-15', '15-30', '30-45', '45-60', '60-90'], axisLine: CHART_STYLE.axisLine, axisLabel: CHART_STYLE.axisLabel },
            yAxis: { type: 'value', axisLine: { show: false }, splitLine: CHART_STYLE.splitLine, axisLabel: CHART_STYLE.axisLabel },
            series: [{ type: 'bar', data: durationBuckets, barWidth: '50%', itemStyle: { color: CHART_COLORS.teal, borderRadius: [4, 4, 0, 0] } }]
          }
        },
        {
          id: 'chart3',
          option: {
            title: { text: 'ËßÇÁúã-ÁÇπËµûÊï£ÁÇπ', ...CHART_STYLE.title },
            tooltip: {
              trigger: 'item',
              ...CHART_STYLE.tooltip,
              formatter: params => `<strong>ËßÇÁúã:</strong> ${params.value[0].toLocaleString()}<br/><strong>ÁÇπËµû:</strong> ${params.value[1].toLocaleString()}`
            },
            grid: CHART_STYLE.grid,
            xAxis: {
              type: 'value',
              name: 'ËßÇÁúã',
              nameLocation: 'center',
              nameGap: 32,
              nameTextStyle: CHART_STYLE.nameTextStyle,
              axisLine: CHART_STYLE.axisLine,
              splitLine: CHART_STYLE.splitLine,
              axisLabel: { ...CHART_STYLE.axisLabel, formatter: val => val >= 1e9 ? (val / 1e9).toFixed(0) + 'B' : val >= 1e6 ? (val / 1e6).toFixed(0) + 'M' : val >= 1e3 ? (val / 1e3).toFixed(0) + 'K' : val }
            },
            yAxis: {
              type: 'value',
              name: 'ÁÇπËµû',
              nameLocation: 'center',
              nameGap: 40,
              nameTextStyle: CHART_STYLE.nameTextStyle,
              axisLine: { show: false },
              splitLine: CHART_STYLE.splitLine,
              axisLabel: { ...CHART_STYLE.axisLabel, formatter: val => val >= 1e9 ? (val / 1e9).toFixed(0) + 'B' : val >= 1e6 ? (val / 1e6).toFixed(0) + 'M' : val >= 1e3 ? (val / 1e3).toFixed(0) + 'K' : val }
            },
            series: [{ type: 'scatter', data: scatter, symbolSize: 8, itemStyle: { color: CHART_COLORS.orange } }]
          }
        },
        {
          id: 'chart4',
          option: {
            title: { text: 'ÂèëÂ∏ÉÊó∂Èó¥Ë∂ãÂäø', ...CHART_STYLE.title },
            tooltip: { trigger: 'axis', ...CHART_STYLE.tooltip },
            grid: CHART_STYLE.grid,
            xAxis: { type: 'category', data: byMonth.map(d => d[0]), axisLine: CHART_STYLE.axisLine, axisLabel: CHART_STYLE.axisLabel },
            yAxis: { type: 'value', axisLine: { show: false }, splitLine: CHART_STYLE.splitLine, axisLabel: CHART_STYLE.axisLabel },
            series: [{ type: 'line', data: byMonth.map(d => d[1]), smooth: true, areaStyle: { color: CHART_COLORS.area }, lineStyle: { color: CHART_COLORS.line } }]
          },
          onClick: params => {
            if (params.name) {
              window.open(`analytics_detail.html?date=${params.name}`, '_blank');
            }
          }
        },
        {
          id: 'chart5',
          option: {
            title: { text: 'ÁÉ≠Èó®È¢ëÈÅì', ...CHART_STYLE.title },
            tooltip: {
              trigger: 'axis',
              axisPointer: { type: 'shadow' },
              ...CHART_STYLE.tooltip,
              formatter: params => {
                const p = params[0];
                return `<strong>${p.name}</strong><br/>ËßÜÈ¢ëÊï∞Ôºö${p.value}`;
              }
            },
            grid: CHART_STYLE.gridWide,
            xAxis: { type: 'value', axisLine: { show: false }, splitLine: CHART_STYLE.splitLine, axisLabel: CHART_STYLE.axisLabel },
            yAxis: {
              type: 'category',
              data: channelCounts.map(c => c.title).reverse(),
              axisLine: CHART_STYLE.axisLine,
              axisLabel: {
                ...CHART_STYLE.axisLabel,
                width: 100,
                overflow: 'truncate',
                ellipsis: '...'
              }
            },
            series: [{ type: 'bar', data: channelCounts.map(c => c.count).reverse(), barWidth: '50%', itemStyle: { color: CHART_COLORS.yellow, borderRadius: [0, 4, 4, 0] } }]
          },
          onClick: params => {
            const index = channelCounts.length - 1 - params.dataIndex;
            const item = channelCounts[index];
            if (item && item.channel_id) {
              window.open(`https://www.youtube.com/channel/${item.channel_id}`, '_blank');
            }
          }
        },
        {
          id: 'chart6',
          option: {
            title: { text: 'Ê†áÁ≠æËØç‰∫ë', ...CHART_STYLE.title },
            series: [{
              type: 'wordCloud',
              shape: 'circle',
              left: 'center',
              top: 'center',
              width: '85%',
              height: '70%',
              sizeRange: [12, 42],
              rotationRange: [0, 0],
              textStyle: { color: () => `hsl(${Math.random() * 60 + 100}, 50%, 40%)` },
              data: tagCounts.length ? tagCounts : [{ name: 'ÊöÇÊó†Ê†áÁ≠æ', value: 1 }]
            }]
          }
        },
        {
          id: 'chart7',
          option: {
            title: { text: 'ÂèÇ‰∏éÂ∫¶Èõ∑Ëææ', ...CHART_STYLE.title },
            tooltip: { ...CHART_STYLE.tooltip },
            radar: {
              ...CHART_STYLE.centerContent,
              indicator: [
                { name: 'ËßÇÁúã', max: radarMax },
                { name: 'ÁÇπËµû', max: radarMax },
                { name: 'ËØÑËÆ∫', max: radarMax }
              ],
              axisLine: CHART_STYLE.axisLine,
              splitLine: { lineStyle: { color: '#E8E8E0' } },
              splitArea: { areaStyle: { color: ['rgba(255,255,255,0)', 'rgba(240,240,235,0.3)'] } }
            },
            series: [{ type: 'radar', data: [{ value: [viewSum, likeSum, commentSum], areaStyle: { color: CHART_COLORS.radarArea }, lineStyle: { color: CHART_COLORS.primary, width: 2 }, itemStyle: { color: CHART_COLORS.primary } }] }]
          }
        },
        {
          id: 'chart8',
          option: {
            title: { text: 'ËßÇÁúãÂàÜÂ∏É', ...CHART_STYLE.title },
            tooltip: { trigger: 'item', ...CHART_STYLE.tooltip, formatter: '{b}: {c} ({d}%)' },
            series: [{
              type: 'pie',
              radius: ['35%', '70%'],
              center: ['50%', '55%'],
              data: viewBuckets,
              label: { color: '#5A5A52', fontSize: 12 },
              itemStyle: { borderRadius: 4, borderColor: '#fff', borderWidth: 2 }
            }]
          }
        },
      ];

      chartConfigs.forEach(cfg => {
        const dom = document.getElementById(cfg.id);
        if (!dom) return;
        if (charts[cfg.id]) {
          charts[cfg.id].dispose();
        }
        const inst = echarts.init(dom, null, { renderer: 'canvas' });
        inst.setOption(cfg.option);
        if (cfg.onClick) inst.on('click', cfg.onClick);
        charts[cfg.id] = inst;
      });
    }

    function renderCards(data) {
      const start = (pagination.page - 1) * pagination.pageSize;
      const end = start + pagination.pageSize;
      const slice = data.slice(start, end);
      const container = document.getElementById('videoCards');
      container.innerHTML = slice.map(item => {
        const url = item.video_id ? `https://www.youtube.com/watch?v=${item.video_id}` : '#';
        const thumb = item.video_id ? `https://i.ytimg.com/vi/${item.video_id}/hqdefault.jpg` : '';
        const views = fmtCompact(item.view_count);
        const likes = fmtCompact(item.like_count);
        const comments = fmtCompact(item.comment_count);
        const subs = item.subscriber_count ? fmtCompact(item.subscriber_count) : null;
        const published = (item.published_at || '').replace('T', ' ').replace('Z', '');
        return `
        <div class="video-card">
          <a class="video-thumb" href="${url}" target="_blank" rel="noopener noreferrer">
            <img src="${thumb}" alt="${escapeHtml(item.title || '')}">
          </a>
          <div class="video-body">
            <a class="video-title" href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(item.title || '')}</a>
            <div class="video-meta"><span>È¢ëÈÅìÔºö<a href="https://www.youtube.com/channel/${item.channel_id}" target="_blank" rel="noopener noreferrer" style="color: inherit;">${escapeHtml(item.channel_title || '')}</a></span></div>
            ${subs ? `<div class="video-meta">üë• ËÆ¢ÈòÖËÄÖÔºö${subs}</div>` : ''}
            <div class="video-meta">üëÅÔ∏è ${views} ¬∑ üëç ${likes} ¬∑ üí¨ ${comments}</div>
            <div class="video-meta">ÂèëÂ∏ÉÊó∂Èó¥Ôºö${published}</div>
            <div class="video-actions">
              <button class="fav-btn" data-video='${JSON.stringify(item).replace(/'/g, "&#39;")}' onclick="toggleFavorite(this)">‚≠ê Êî∂Ëóè</button>
            </div>
          </div>
        </div>`;
      }).join('');
      const totalPages = Math.max(1, Math.ceil(data.length / pagination.pageSize));
      document.getElementById('pageInfo').textContent = `Á¨¨ ${pagination.page} / ${totalPages} È°µ`;
      document.getElementById('prevPage').disabled = pagination.page <= 1;
      document.getElementById('nextPage').disabled = pagination.page >= totalPages;
    }

    function updateAll(data) {
      const sorted = [...data].sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
      cachedData = sorted;
      renderStats(sorted);
      renderCharts(sorted);
      renderCards(sorted);
    }
    async function triggerCollect(isAuto = false, keywordList = null) {
      const keywordsInput = document.getElementById('keywords');
      const daysInput = document.getElementById('days');
      const keywords = keywordsInput.value.trim();
      const max_results = parseInt(document.getElementById('maxResults').value, 10) || DEFAULT_MAX;
      const daysRaw = daysInput.value;
      const days = daysRaw === '' ? DEFAULT_DAYS : Number(daysRaw);
      const kwList = Array.isArray(keywordList) && keywordList.length ? keywordList : (keywords ? [keywords] : []);
      if (!kwList.length) { log('ËØ∑ËæìÂÖ•ÂÖ≥ÈîÆËØç'); return; }
      const payload = { max_results, days };
      if (Array.isArray(keywordList) && keywordList.length) {
        payload.keyword_list = keywordList;
      } else {
        payload.keywords = keywords;
      }
      log(`ÂºÄÂßãÈááÈõÜÔºö${kwList.join(' / ')}, max=${max_results}, days=${days}`);
      try {
        setCollecting(true);
        const resp = await fetch(`${backendBase}/collect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) {
          log(`ÈááÈõÜÂ§±Ë¥•Ôºö${data.error || resp.status}`);
          return;
        }
        log(`ÈááÈõÜÂÆåÊàêÔºöÂÖ± ${data.total} Êù°ÔºåÂ∑≤ÂÜôÂÖ• ${data.data_file}`);
        await loadData();
      } catch (err) {
        log(`ËØ∑Ê±ÇÂ§±Ë¥•Ôºö${err}`);
      } finally {
        setCollecting(false);
      }
    }

    async function loadData() {
      try {
        const res = await fetch('./shorts.json');
        if (!res.ok) { log('ËØªÂèñ shorts.json Â§±Ë¥•'); return false; }
        const json = await res.json();
        saveToLocalStorage(json);
        updateAll(json);
        return true;
      } catch (err) {
        log(`Âä†ËΩΩÂ§±Ë¥•Ôºö${err}`);
        return false;
      }
    }

    function exportReport() {
      const data = cachedData;
      if (!data.length) { log('Êó†Êï∞ÊçÆÂèØÂØºÂá∫'); return; }
      const total = data.length;
      const views = data.reduce((s, v) => s + (+v.view_count || 0), 0);
      const likes = data.reduce((s, v) => s + (+v.like_count || 0), 0);
      const comments = data.reduce((s, v) => s + (+v.comment_count || 0), 0);
      const stats = { total, views, likes, comments };
      const topVideos = [...data].sort((a, b) => (b.view_count || 0) - (a.view_count || 0)).slice(0, 20);
      const topChannels = groupCount(data, v => v.channel_title || 'Êú™Áü•').slice(0, 10)
        .map(([channel, count]) => ({ channel, count }));
      const tagMap = new Map();
      data.forEach(v => (v.tags || []).forEach(t => tagMap.set(t, (tagMap.get(t) || 0) + 1)));
      const topTags = [...tagMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 20)
        .map(([tag, count]) => ({ tag, count }));
      const payload = { generated_at: new Date().toISOString(), stats, topVideos, topChannels, topTags };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'report.json'; a.click();
      URL.revokeObjectURL(url);
      log('Â∑≤ÂØºÂá∫ report.json');
    }

    function renderQuickPills() {
      const box = document.getElementById('quickPills');
      if (!box) return;
      box.innerHTML = QUICK_PRESETS.map((preset, idx) => `
        <button class="pill" data-idx="${idx}">${preset.label}</button>
      `).join('');
      box.querySelectorAll('.pill').forEach(btn => {
        btn.onclick = () => {
          const preset = QUICK_PRESETS[Number(btn.dataset.idx)];
          if (!preset) return;
          document.getElementById('keywords').value = preset.keywords.join(' / ');
          triggerCollect(false, preset.keywords);
        };
      });
    }

    document.getElementById('collectBtn').onclick = triggerCollect;
    document.getElementById('exportBtn').onclick = exportReport;
    document.getElementById('clearLog').onclick = () => { logBox.textContent = ''; };
    document.getElementById('logToggle').onclick = toggleLog;
    document.getElementById('prevPage').onclick = () => { if (pagination.page > 1) { pagination.page--; renderCards(cachedData); } };
    document.getElementById('nextPage').onclick = () => {
      const totalPages = Math.max(1, Math.ceil(cachedData.length / pagination.pageSize));
      if (pagination.page < totalPages) { pagination.page++; renderCards(cachedData); }
    };
    document.getElementById('pageSize').onchange = (e) => {
      pagination.pageSize = Number(e.target.value);
      pagination.page = 1;
      renderCards(cachedData);
    };

    (function init() {
      // Set default values
      document.getElementById('days').value = DEFAULT_DAYS;

      const local = loadFromLocalStorage();
      if (local.length) {
        log(`Â∑≤‰ªé localStorage ËØªÂèñ ${local.length} Êù°`);
        updateAll(local);
      } else {
        log('localStorage Êó†Êï∞ÊçÆÔºåËØ∑ËæìÂÖ•ÂÖ≥ÈîÆËØçÈááÈõÜ');
      }
      renderQuickPills();
      loadFavorites();
    })();;
  </script>
</body>

</html>